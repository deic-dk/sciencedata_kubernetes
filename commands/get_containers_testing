#!/bin/bash

owner="$@"
TMPDIR="/tmp"

user=`echo $owner | awk -F@ '{print $1}'`
domain=`echo $owner | awk -F@ '{print $2}'`

echo "###" >&2
echo "pod_name|container_name|image_name|pod_ip|node_ip|owner|age|status|ssh_port|ssh_username|https_port|uri" >&2
echo "###" >&2
#if [[ -n $owner ]]; then
#    alljson=`kubectl get pods -l "user=$user,domain=$domain" -o json`
#else
#    alljson=`kubectl get pods -o json`
#fi
nowSeconds=`date +"%s"`
kubectl get pods -l "user=$user,domain=$domain" -o json | jq -r '.items[] | {name: .metadata.name, cname: .spec.containers[].name, image: .spec.containers[].image, podIP: .status.podIP, hostIP: .status.hostIP, user: .metadata.labels.user, domain: .metadata.labels.domain, starttime: .status.startTime, state: .status.phase, message: .status.conditions|map(select(has("message")).message)[0]?, status: .status.containerStatuses[]?.state[]? | join(", "), sshuser: .spec.containers[]|[.env[]?]|map(select(.name=="USERNAME").value)[0]?, rpport: .metadata.labels.reverseProxyPort}' | jq -r '.name+"|"+.cname+"|"+.image+"|"+.podIP+"|"+.hostIP+"|"+.user+"|"+.domain+"|"+.starttime+"|"+.status+"|"+.state+"|"+.message+"|"+.sshuser+"|"+.rpport' | while read line; do
    startTime=`echo "$line" | awk '{split($0,a,"|"); print a[8];}' | date +"%s"`
    if [ -n "$startTime" -a "$startTime" != null ]; then
        startSeconds=`echo "$starttime" | date +"%s"`
        diffSeconds=$((nowSeconds-startSeconds))
    else
        diffSeconds=0
    fi
    domain=`echo "$line" | awk '{split($0,a,"|"); print a[7];}'`
    user=`echo "$line" | awk '{split($0,a,"|"); print a[6];}'`
	  if [ -n "$domain" ]; then
		    owner="$user@$domain"
	  else
		    owner="$user"
	  fi
    podName=`echo "$line" | awk '{split($0,a,"|"); print a[1];}'`
	  nodePort=`kubectl get service "${podName}-ssh" -o json 2>/dev/null | jq -r '.spec.ports[].nodePort'`
	  uri=`cat ${TMPDIR}/uri-${podName} 2>/dev/null`
    echo "$line" | awk -v OWNER="$owner" -v NODEPORT="$nodePort" -v DIFFSECONDS="$diffseconds" -v URI="$URI" \
                       '{split($0,a,"|"); printf "%s|%s|%s|%s|%s|%s|%s|%s|%s|%s|%s|%s",a[1],a[2],a[3],a[4],a[5],OWNER,DIFFSECONDS,a[9],NODEPORT,a[12],a[13],URI; print ""}'
done

